# ostle_solver

https://gamemarket.jp/game/76310

※Ostle（オストル）は 雅ゲームスにより制作されたボードゲームです。当リポジトリと雅ゲームスとの関係はありません。

cf:
http://h1.hara.net.it-chiba.ac.jp/ostle/

ｶﾞﾊﾞｱﾙｶﾓ

## 局面の全列挙

まず最初に、初期局面から到達可能な局面を全列挙して、その総数（あるいはその上界）を求めた。

### 全列挙の定義

- 対称な局面は同一視する。（水平反転・垂直反転・行列転置の3操作をやるorやらないで合計8通りの対称性がある）
- 手番側が即座に勝利できる局面までを含み、その手を指して勝利した後の局面は含めない。
- 手番側が即座に勝利できる局面でも、その手を指さなくてもよいとする。言い換えると、どこかで勝利を見逃さないと決して辿り着けないような局面も含める。

### 考察

最初に空白25マスあって『最初に穴1個を配置して、残り24マスに手番側のコマ5or4個と相手のコマ5or4個を配置する』と解釈し、これの場合の数を考える。このとき対称な局面を同一視するならば、穴の配置箇所として考慮すべき場所は、下図で"o"になっている6マス（実装上の番号では0,1,2,6,7,12）だけでよい。なぜなら、その他のマスに穴を配置した場合、その後でコマをどのように配置しようとも、結果生じる盤面と対称な盤面が、列挙した盤面のなかに必ず存在するからである。

| 0 | 1 | 2 | 3 | 4 |
|---|---|---|---|---|
| o | o | o | . | . |
| . | o | o | . | . |
| . | . | o | . | . |
| . | . | . | . | . |
| . | . | . | . | . |

もう一つのobservationとして、上記の6マスのうち別の穴に配置した2つの盤面同士は、決して対称にならない。また手番側or相手のコマの数が異なる盤面同士も決して対称にならない。ゆえに、『穴の位置とコマの数』の場合分け（24通り）によって、全局面を網羅しつつ相互排他的に分割できる。加えて、対称な局面の検出もその分割の内側同士でだけ考慮すればよくなる。

### 結果（局面数）

合計2,735,147,685局面だった。ただし、これは初期局面から到達不可能な局面を含む可能性がある。

| 穴の位置 | 手番側のコマの数 | 相手のコマの数 | 局面数 |
|---:|---:|---:|---:|
| 0 | 5 | 5 | 247127256 |
| 1 | 5 | 5 | 494236512 |
| 2 | 5 | 5 | 247127256 |
| 6 | 5 | 5 | 247127256 |
| 7 | 5 | 5 | 247127256 |
| 12 | 5 | 5 | 61788564 |
| 0 | 5 | 4 | 82378152 |
| 1 | 5 | 4 | 164745504 |
| 2 | 5 | 4 | 82378152 |
| 6 | 5 | 4 | 82378152 |
| 7 | 5 | 4 | 82378152 |
| 12 | 5 | 4 | 20598588 |
| 0 | 4 | 5 | 82378152 |
| 1 | 4 | 5 | 164745504 |
| 2 | 4 | 5 | 82378152 |
| 6 | 4 | 5 | 82378152 |
| 7 | 4 | 5 | 82378152 |
| 12 | 4 | 5 | 20598588 |
| 0 | 4 | 4 | 25744590 |
| 1 | 4 | 4 | 51482970 |
| 2 | 4 | 4 | 25744590 |
| 6 | 4 | 4 | 25744590 |
| 7 | 4 | 4 | 25744590 |
| 12 | 4 | 4 | 6438855 |


## その他

### undo関数の必要性について

盤面pのポインタと指し手mを引数に取り、mを指して盤面をp'に更新する関数をdo関数と呼ぶ。逆に、p'のポインタとmを引数に取りp'をpに戻す関数をundo関数と呼ぶ。

将棋ソフトとかではこのように1個の盤面データを破壊的変更しながら探索するのが普通である。そのような方式を取る理由はそのほうが速いからだが、背景事情として (1) pのデータ構造が大きい (2) 手を指すことによる盤面の変更が局所的である (3) 評価関数を差分評価するときの差分更新も(un)do関数のタイミングで行う などがある。

今回はundo関数を実装してしまったが、結局使わなかった。全列挙するだけなので差分評価とかは無いわけだが、そういう背景の違いを検討せずになんとなく実装してしまったのだった。
